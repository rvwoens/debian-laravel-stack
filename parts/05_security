#!/bin/bash

. ${BASH_SOURCE%/*}/00_settings

logline "05.00 security"

logline "05.01 ssh security"

sshtemp=`mktemp`
cat /etc/ssh/sshd_config | sed -e "s/PasswordAuthentication yes/PasswordAuthentication no/" >$sshtemp

cat <<-'EOF' >>$sshtemp
	PermitRootLogin no
	Protocol 2
	UsePrivilegeSeparation yes
	SyslogFacility AUTH
	LogLevel INFO
	StrictModes yes
	PubkeyAuthentication yes
	IgnoreRhosts yes
	HostbasedAuthentication no
	PermitEmptyPasswords no
	X11Forwarding no
	GatewayPorts no
	PrintMotd no
	TCPKeepAlive yes
	PasswordAuthentication no
	# allow older ssh clients to connect (dbeaver)
    PubkeyAcceptedKeyTypes +ssh-rsa
EOF
mv -f $sshtemp /etc/ssh/sshd_config
# only readable by root
chmod 0600 /etc/ssh/sshd_config
# and reboot the service
systemctl restart ssh.service


logline "05.02 firewall"

# Set defaults
ufw default deny incoming
ufw default allow outgoing

# Allow SSH first (important!)
ufw allow 22/tcp

# Add port 80 and 443
ufw allow 80/tcp
ufw allow 443/tcp

# Enable the firewall
ufw enable

# Show overview
ufw status verbose

logline "05.03 fail2ban aggressive sshd protection"
apt install -y fail2ban
cat <<-'EOF' >/etc/fail2ban/jail.local
	[sshd]
	enabled = true
	maxretry = 3
	bantime = 86400
	mode = aggressive
EOF
systemctl start fail2ban
systemctl enable fail2ban

# Check status
fail2ban-client status

# Check specific jail
fail2ban-client status sshd

logline "05.99 security END"

